<div class="-mt-16 min-h-screen flex flex-col p-4 sm:p-6 bg-white/90 backdrop-blur-lg text-[var(--Black)]">

  <!-- ========= HEADER CALENDRIER ========= -->
  <header
    class="mt-20 flex flex-col md:flex-row items-center justify-between gap-4 mb-6 p-4 bg-white/80 backdrop-blur-lg border border-gray-200 rounded-xl shadow-lg"
    role="banner">

    <!-- GAUCHE : TITRE + BOUTON AUJOURD'HUI -->
    <div class="flex items-center gap-4">
      <h1 id="calendarTitle" aria-live="polite" class="text-2xl md:text-3xl font-bold tracking-tight drop-shadow-sm">
        {{ viewMode === 'month' ? monthLabel() : weekLabel() }}
      </h1>
      <button (click)="goToday()"
        class="hidden md:inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-full bg-[var(--Rouge)] text-white shadow-md hover:bg-[var(--Rouge-Foncé)] hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-[var(--Rouge-Clair)]">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path
            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" />
        </svg>
        Aujourd’hui
      </button>
    </div>

    <!-- DROITE : CONTRÔLES -->
    <nav class="flex flex-wrap items-center gap-3" role="group" aria-label="Contrôles calendrier">

      <!-- Mode Vue -->
      <div class="inline-flex items-center gap-1 bg-gray-100 rounded-xl p-1 shadow-sm">
        <button (click)="viewMode='month'" [attr.aria-pressed]="viewMode === 'month'"
          class="px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]"
          [ngClass]="viewMode === 'month' ? 'bg-[var(--Rouge)] text-white shadow-md scale-105' : 'bg-transparent text-gray-600 hover:bg-gray-200'">
          Mois
        </button>
        <button (click)="viewMode='week'" [attr.aria-pressed]="viewMode === 'week'"
          class="px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]"
          [ngClass]="viewMode === 'week' ? 'bg-[var(--Rouge)] text-white shadow-md scale-105' : 'bg-transparent text-gray-600 hover:bg-gray-200'">
          Semaine
        </button>
      </div>

      <!-- Navigation Période -->
      <div class="flex items-center gap-2">
        <button (click)="viewMode==='month' ? prevMonth() : prevWeek()" aria-label="Période précédente"
          class="flex items-center gap-1 px-3 py-2 rounded-lg bg-gray-100 hover:bg-[var(--Rouge)] hover:text-white transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-[var(--Rouge-Clair)]">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          <span class="hidden sm:inline">Précédent</span>
        </button>

        <label for="jumpDate"
          class="flex items-center justify-center p-2 rounded-lg bg-gray-100 hover:bg-[var(--Rouge)] hover:text-white cursor-pointer transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-[var(--Rouge-Clair)]">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </label>

        <button (click)="viewMode==='month' ? nextMonth() : nextWeek()" aria-label="Période suivante"
          class="flex items-center gap-1 px-3 py-2 rounded-lg bg-gray-100 hover:bg-[var(--Rouge)] hover:text-white transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-[var(--Rouge-Clair)]">
          <span class="hidden sm:inline">Suivant</span>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      </div>

      <!-- Bouton Créer Événement -->
      <button *ngIf="canEdit()" (click)="openPopup()"
        class="hidden md:inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-gradient-to-b from-[var(--Rouge)] to-[var(--Rouge-Foncé)] hover:from-[var(--Bleu)] hover:to-[var(--Bleu-Foncé)] text-white font-semibold shadow-md hover:shadow-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-[var(--Rouge-Clair)]">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        <span>Créer</span>
      </button>
    </nav>
  </header>

  <!-- BOUTON FLOTTANT MOBILE -->
  <button *ngIf="canEdit()" (click)="openPopup()"
    class="md:hidden fixed bottom-6 right-6 z-30 w-14 h-14 rounded-full bg-[var(--Rouge)] text-white shadow-lg grid place-items-center hover:bg-[var(--Rouge-Foncé)] active:scale-95 transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-[var(--Rouge)]/50"
    aria-label="Ajouter un événement">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
    </svg>
  </button>

  <!-- =================== VUE MOIS =================== -->
  <div *ngIf="viewMode==='month'" class="grid grid-cols-7 gap-2">
    <ng-container *ngFor="let day of monthDays">
      <div *ngIf="day" [ngClass]="{
          'bg-[var(--Rouge)]/60 text-white font-bold': isToday(day),
          'bg-[var(--Blanc)]/10 hover:bg-[var(--Bleu)]/20': !isToday(day)
        }"
        class="border min-h-[120px] md:min-h-[140px] p-3 md:p-4 relative rounded-xl cursor-pointer transition-colors duration-200 backdrop-blur-md shadow-sm">

        <!-- Nom du jour -->
        <div class="text-xs md:text-sm mb-1" [ngClass]="{ 'text-white': isToday(day), 'text-gray-500': !isToday(day) }">
          {{ dayName(day) }}
        </div>

        <!-- Numéro du jour -->
        <div class="text-sm md:text-base font-semibold mb-2"
          [ngClass]="{ 'text-white': isToday(day), 'text-[var(--Black)]': !isToday(day) }">
          {{ dayNum(day) }}
        </div>

        <!-- Événements -->
        <div *ngFor="let evt of getEventsByDay(day); let i = index"
          class="absolute mt-10 left-1 right-1 rounded-md px-2 py-1 text-xs md:text-sm cursor-pointer overflow-hidden flex items-center gap-1 hover:opacity-90 transition-all duration-200"
          [ngClass]="getEventColor(evt)" [style.top.px]="30 + i * 28" (click)="openEventDetails(evt)">
          <i [class]="getEventIcon(evt) + ' text-white'"></i>
          <span class="truncate text-white">{{ evt.title }}</span>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- =================== VUE SEMAINE =================== -->
  <section *ngIf="viewMode === 'week'" class="flex flex-col w-full h-full" aria-label="Calendrier hebdomadaire">

    <!-- Header de la semaine -->
    <header class="flex w-full bg-white text-[var(--Black)] rounded-t-lg shadow-md">
      <div class="w-12"></div>
      <div class="flex-1 flex">
        <div *ngFor="let day of weekDays; let i = index"
          class="flex-1 border-l border-gray-200 flex flex-col items-center justify-center p-2 md:p-3 relative rounded-t-lg transition-colors duration-200"
          [ngClass]="{
               'bg-[var(--Rouge)] text-[var(--Blanc)] font-bold shadow-md': isToday(day),
               'hover:bg-gray-100': !isToday(day)
             }" [attr.aria-current]="isToday(day) ? 'date' : null">
          <span class="text-xs md:text-sm font-semibold tracking-wide">
            {{ weekDayHeaders[i] | slice:0:3 }}
          </span>
          <span class="text-sm md:text-base font-bold mt-1">{{ dayNum(day) }}</span>
        </div>
      </div>
    </header>

    <!-- Contenu principal -->
    <main class="flex flex-1 overflow-auto bg-white/80 backdrop-blur-md">

      <!-- Heures sur la gauche -->
      <div class="w-12 flex flex-col bg-white text-[var(--Black)]">
        <div *ngFor="let h of hours" class="h-14 flex items-start justify-end pr-1 border-b border-gray-200">
          <span class="text-xs text-[var(--Black)]">{{ h }}</span>
        </div>
      </div>

      <!-- Jours de la semaine -->
      <div class="flex-1 flex gap-1">
        <div *ngFor="let day of weekDays"
          class="flex-1 relative border-l border-gray-200 bg-[var(--Blanc)/50] rounded-lg shadow-inner">

          <!-- Grille des heures -->
          <div *ngFor="let h of hours; let j = index"
            class="h-14 border-b border-gray-200 hover:bg-[var(--Gris)]/10 transition-colors duration-200 cursor-pointer">
          </div>

          <!-- Événements -->
          <article *ngFor="let evt of getEventsByDay(day)"
            class="absolute left-0 right-0 px-2 py-1 text-xs md:text-sm font-medium cursor-pointer overflow-hidden shadow hover:shadow-lg flex flex-col justify-between transition-all duration-200 rounded-md"
            [ngClass]="getEventColor(evt)" [style.top.px]="getEventTopOffset(evt)"
            [style.height.px]="getEventHeight(evt)" [class.opacity-100]="isPast(day)" tabindex="0" role="button"
            [attr.aria-label]="evt.title" (click)="openEventDetails(evt)" (keyup.enter)="openEventDetails(evt)">

            <!-- Titre avec icône -->
            <div class="flex items-center gap-1 text-white font-semibold truncate">
              <i [class]="getEventIcon(evt) + ' text-white'"></i>
              <span>{{ evt.title }}</span>
            </div>

            <!-- Nom du coach -->
            <div class="text-[10px] md:text-[11px] text-white/70 truncate mt-1">
              {{ evt.coach }}
            </div>

            <!-- Heures alignées à droite -->
            <div class="flex justify-end text-white/80 text-[10px] md:text-xs font-mono -mt-1">
              <span class="mr-1">{{ evt.hour }}</span>
              <span>-</span>
              <span class="ml-1">{{ evt.endHour }}</span>
            </div>

          </article>
        </div>
      </div>
    </main>
  </section>

  <!-- =================== POPUP AJOUT/MODIFICATION =================== -->
  <div *ngIf="showPopup"
    class="fixed inset-0 z-50 flex items-center justify-center bg-[var(--Black)]/30 backdrop-blur-lg p-4">
    <div
      class="w-full max-w-lg rounded-3xl bg-white/90 backdrop-blur-2xl border border-gray-300 shadow-2xl p-8 text-[var(--Black)] relative">
      <button (click)="showPopup=false" aria-label="Fermer"
        class="absolute top-4 right-4 p-2 rounded-full bg-gray-200 hover:bg-[var(--Rouge)]/20 transition">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <h2 class="text-2xl font-bold mb-6 text-[var(--Rouge)]">{{ isEditing ? 'Modifier événement' : 'Ajouter événement'
        }}</h2>
      <div class="flex flex-col gap-4">
        <input type="text" placeholder="Titre" [(ngModel)]="newEventTitle"
          class="w-full p-3 bg-white border border-gray-300 rounded-xl placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]" />
        <input type="date" [(ngModel)]="newEventDate"
          class="w-full p-3 bg-white border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]" />
        <div class="flex gap-2">
          <input type="time" [(ngModel)]="newEventHour"
            class="w-1/2 p-3 bg-white border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]" />
          <input type="time" [(ngModel)]="newEventEndHour"
            class="w-1/2 p-3 bg-white border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]" />
        </div>
        <input type="text" placeholder="Votre Nom . Votre Prénom" [(ngModel)]="newEventCoach"
          class="w-full p-3 bg-white border border-gray-300 rounded-xl placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]" />
        <select [(ngModel)]="newEventCategory"
          class="w-full p-3 bg-white border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]">
          <option value="" disabled selected>Catégorie</option>
          <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
        </select>
        <select [(ngModel)]="newEventLevel"
          class="w-full p-3 bg-white border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]">
          <option value="" disabled selected>Niveau</option>
          <option *ngFor="let lvl of levels" [value]="lvl">{{ lvl }}</option>
        </select>
        <textarea placeholder="Description" [(ngModel)]="newEventDescription" rows="4"
          class="w-full p-3 bg-white border border-gray-300 rounded-xl placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]"></textarea>
      </div>
      <div class="flex justify-end gap-4 mt-6">
        <button (click)="showPopup=false"
          class="px-5 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 transition">Annuler</button>
        <button (click)="addEvent()"
          class="px-5 py-2 rounded-xl bg-gradient-to-r from-[var(--Rouge)] to-[var(--Rouge-Foncé)] hover:from-[var(--Bleu)] hover:to-[var(--Bleu-Foncé)] text-white font-semibold shadow-lg hover:shadow-xl transition">
          {{ isEditing ? 'Modifier' : 'Ajouter' }}
        </button>
      </div>
    </div>
  </div>

  <!-- =================== DÉTAIL ÉVÉNEMENT =================== -->
  <div *ngIf="selectedEvent"
    class="fixed inset-0 z-50 flex items-center justify-center bg-[var(--Black)]/30 backdrop-blur-lg p-4">
    <div
      class="w-full max-w-lg rounded-3xl bg-white/90 backdrop-blur-2xl border border-gray-300 shadow-2xl p-8 text-[var(--Black)] relative">
      <button (click)="closeEventDetails()" aria-label="Fermer"
        class="absolute top-4 right-4 p-2 rounded-full bg-gray-200 hover:bg-[var(--Rouge)]/20 transition">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <h2 class="text-2xl font-bold mb-2 text-[var(--Rouge)]">{{ selectedEvent.title }}</h2>
      <p class="text-sm mb-4 text-gray-500">{{ selectedEvent.category }}</p>
      <div class="space-y-4 text-[var(--Black)]">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-full bg-[var(--Rouge)] flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </div>
          <div>
            <p class="text-xs text-gray-500">Nom . Prénom</p>
            <p class="font-medium">{{ selectedEvent.coach }}</p>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <div>
            <p class="text-xs text-gray-500">Date & heure</p>
            <p class="font-medium">{{ selectedEvent.day }} • {{ selectedEvent.hour }} - {{ selectedEvent.endHour }}</p>
          </div>
        </div>
        <div *ngIf="selectedEvent.description" class="pt-3 border-t border-gray-200">
          <p class="text-xs text-gray-500 mb-1">Description</p>
          <p class="leading-relaxed text-gray-700">{{ selectedEvent.description }}</p>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-6">
        <button (click)="closeEventDetails()"
          class="px-5 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 transition">Fermer</button>
        <button (click)="deleteEvent(selectedEvent)" *ngIf="canEdit()"
          class="px-5 py-2 rounded-xl bg-[var(--Rouge)] hover:bg-[var(--Rouge-Foncé)] text-white font-semibold transition">Supprimer</button>
      </div>
    </div>
  </div>

</div>