<div class="-mt-15 flex flex-col md:flex-row h-screen bg-[var(--Black)]/88 shadow-2xl overflow-hidden">

  <!-- Colonne contacts -->
  <aside class="mt-15 w-full md:w-1/3 flex flex-col bg-[var(--Black)]/30 border-r border-[var(--Blanc)] overflow-hidden">

    <!-- Header utilisateur -->
    <header class="p-4 border-b border-[var(--Blanc)]/20 flex items-center gap-3">
      <div
        class="w-12 h-12 md:w-14 md:h-14 bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] text-[var(--Blanc)] rounded-full flex items-center justify-center text-lg md:text-xl font-semibold shadow-lg">
        {{ userInitiales }}
      </div>
      <div class="flex-1 min-w-0">
        <h2 class="font-semibold text-lg md:text-xl text-[var(--Blanc)] truncate">{{ userPrenom }} {{ userNom }}</h2>
        <p class="text-sm md:text-base text-green-400 flex items-center gap-1">
          <span class="w-2 h-2 md:w-3 md:h-3 bg-green-400 rounded-full animate-pulse"></span> Connecté
        </p>
      </div>
    </header>

    <!-- Recherche -->
    <div class="p-4 border-b border-[var(--Blanc)]/10">
      <label for="search-contact" class="sr-only">Rechercher un contact</label>
      <div class="relative">
        <input id="search-contact" type="text" placeholder="Rechercher un contact..."
          [(ngModel)]="searchText"
          (input)="onSearchChange(searchText)"
          (focus)="showSuggestions = filteredContacts.length > 0"
          (blur)="hideSuggestions()"
          class="w-full pl-10 pr-4 py-3 md:py-4 rounded-xl bg-[var(--Gris)]/60 text-[var(--Blanc)] placeholder-[var(--Blanc)]/50 border-2 border-[var(--Rouge)]/30 focus:border-[var(--Rouge)] focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]/30 transition-all duration-300" />
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[var(--Rouge)]"></i>

        <!-- Suggestions -->
        <ul *ngIf="showSuggestions"
          class="absolute top-full left-0 right-0 bg-[var(--Gris)]/90 backdrop-blur-lg rounded-xl shadow-lg max-h-48 overflow-y-auto z-20 mt-1 animate-fade-in-up">
          <li *ngFor="let contact of filteredContacts" (mousedown)="selectSuggestion(contact)"
            class="p-3 cursor-pointer hover:bg-[var(--Rouge)]/70 transition flex items-center gap-3 rounded-lg">
            <div
              class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] text-[var(--Blanc)] rounded-full flex items-center justify-center text-sm md:text-base font-medium">
              {{ contact.firstName[0] }}{{ contact.lastName[0] }}
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-medium text-[var(--Blanc)] truncate">{{ contact.firstName }} {{ contact.lastName }}</div>
              <div class="text-xs md:text-sm text-[var(--Blanc)]/60">Cliquez pour ouvrir</div>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <!-- Liste contacts -->
    <nav class="flex-1 overflow-y-auto p-3 gap-3 flex flex-col
         scrollbar-thin scrollbar-thumb-[var(--Rouge)] scrollbar-track-transparent">
      <a *ngFor="let contact of contacts; trackBy: trackByContactId" role="button" tabindex="0"
        (click)="selectContact(contact)" (keyup.enter)="selectContact(contact)"
        [attr.aria-label]="'Conversation avec ' + contact.firstName + ' ' + contact.lastName"
        [attr.aria-current]="selectedContact?._id === contact._id"
        [class.is-active]="selectedContact?._id === contact._id"
        class="contact-card flex items-center gap-3 p-2 md:p-3 rounded-lg transition hover:bg-[var(--Rouge)]/50">

        <div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] flex items-center justify-center text-white font-medium">
          {{ contact.firstName[0] }}{{ contact.lastName[0] }}
        </div>

        <div class="min-w-0">
          <p class="name text-[14px] md:text-base text-[var(--Blanc)] truncate">{{ contact.firstName }} {{ contact.lastName }}</p>
        </div>
      </a>
    </nav>
  </aside>

  <!-- Zone chat -->
  <main class="mt-15 flex-1 flex flex-col bg-[var(--Gris)]/10 backdrop-blur-lg overflow-hidden">

    <ng-container *ngIf="selectedContact; else placeholder">
      <!-- Header chat -->
      <header
        class="bg-[var(--Gris)]/20 px-4 md:px-6 py-3 md:py-4 border-b border-[var(--Rouge)]/20 flex items-center gap-3 md:gap-4 sticky top-0 z-10 shadow-md">
        <div class="relative">
          <div
            class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] text-[var(--Blanc)] rounded-full flex items-center justify-center text-sm md:text-base font-medium shadow-md">
            {{ selectedContact.firstName[0] }}{{ selectedContact.lastName[0] }}
          </div>
          <span
            class="absolute bottom-0 right-0 w-3 h-3 md:w-4 md:h-4 bg-green-400 border-2 border-[var(--Blanc)] rounded-full"></span>
        </div>
        <div class="flex-1">
          <h3 class="font-semibold text-[var(--Blanc)] text-sm md:text-lg">{{ selectedContact.firstName }} {{ selectedContact.lastName }}</h3>
          <p class="text-xs md:text-sm text-green-400 flex items-center gap-1"><span
              class="w-2 h-2 md:w-3 md:h-3 bg-green-400 rounded-full animate-pulse"></span> En ligne</p>
        </div>
      </header>

      <!-- Messages -->
      <section #messagesContainer
        role="log"
        aria-live="polite"
        class="flex-1 overflow-y-auto px-3 md:px-4 py-3 space-y-4 scrollbar-none [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]">
        <article *ngFor="let msg of messages; trackBy: trackByMsgId"
          [attr.aria-label]="msg.senderName + ' : ' + msg.text"
          class="flex items-end gap-2 text-sm"
          [class.flex-row-reverse]="msg.senderId === userId">

          <div class="w-7 h-7 md:w-9 md:h-9 rounded-full bg-gradient-to-br from-[var(--Bleu)] to-[var(--Bleu-Foncé)] border border-white/20 flex items-center justify-center text-white text-[10px] md:text-[12px] font-semibold shadow-md shrink-0">
            {{ msg.senderId === userId ? userInitiales : getInitiales(msg.senderName) }}
          </div>

          <div class="max-w-[70%] min-w-[120px] group">
            <div class="text-white/40 text-[10px] md:text-[12px] px-1 mb-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200"
              [ngClass]="{'text-right': msg.senderId === userId, 'text-left': msg.senderId !== userId}">
              {{ msg.timestamp | date:'HH:mm' }}
            </div>

            <div [ngClass]="msg.senderId === userId
              ? 'bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] text-white rounded-br-none'
              : 'bg-white/10 text-white rounded-bl-none backdrop-blur-sm'"
              class="relative px-4 py-2 rounded-2xl shadow-lg animate-slide-in-bottom break-words">
              <p>{{ msg.text }}</p>

              <div *ngIf="msg.senderId === userId && msg.id === messages[messages.length-1]?.id"
                class="absolute -bottom-1 -right-3 text-[10px] md:text-[12px] text-white/60 flex items-center gap-1">
                <i class="fa-solid fa-check-double"></i>
              </div>
            </div>
          </div>
        </article>
      </section>

      <!-- Input message -->
      <footer class="bg-[var(--Gris)]/20 border-t border-[var(--Rouge)]/20 p-3 md:p-4 rounded-b-xl">
        <form (ngSubmit)="sendMessage()" class="flex items-center gap-2 md:gap-3">
          <input
            id="message-input"
            type="text"
            [(ngModel)]="newMessage"
            name="newMessage"
            required
            placeholder="Écrire un message..."
            class="flex-1 px-3 md:px-4 py-2 md:py-3 border-2 border-[var(--Gris)]/30 rounded-full bg-[var(--Gris)]/10 text-[var(--Blanc)] placeholder-[var(--Blanc)]/50 focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]/30 transition-all duration-300"
          />
          <button
            type="submit"
            [disabled]="!newMessage?.trim()"
            [ngClass]="{'bg-[var(--Rouge)] hover:bg-[var(--Rouge-Foncé)]': newMessage?.trim(), 'bg-[var(--Gris)]/30 cursor-not-allowed': !newMessage?.trim()}"
            class="p-2 md:p-3 rounded-full text-[var(--Blanc)] transition shadow-lg hover:shadow-xl disabled:shadow-none"
            aria-label="Envoyer le message">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </footer>
    </ng-container>

    <ng-template #placeholder>
      <div
        class="flex-1 flex flex-col items-center justify-center bg-black/60 backdrop-blur-xl p-6 md:p-8 text-center shadow-2xl shadow-black/30 ring-1 ring-white/10 animate-fade-in-up">
        <div class="border-2 border-[var(--Rouge)] rounded-xl pt-8 pb-8 px-6 md:px-10">
          <div class="relative mb-6">
            <i class="fas fa-comments text-4xl md:text-5xl text-white/40 animate-pulse-slow drop-shadow-lg"></i>
          </div>
          <h3 class="text-xl md:text-2xl font-bold text-white mb-2 animate-fade-in-up [animation-delay:100ms]">
            Aucune conversation sélectionnée
          </h3>
          <p class="text-white/70 max-w-xs mb-4 md:text-base animate-fade-in-up [animation-delay:200ms]">
            Sélectionnez un contact dans la liste pour commencer à discuter.
          </p>
          <div class="flex items-center gap-2 text-white/50 text-sm md:text-base animate-fade-in-up [animation-delay:300ms]"
            tooltip="Chiffrement de bout en bout – aucun historique conservé.">
            <i class="fas fa-lock-alt"></i>
            <span>Les messages sont supprimés automatiquement après 24 h.</span>
          </div>
        </div>
      </div>
    </ng-template>
  </main>
</div>
