<!-- Container principal -->
<div class="-mt-16 flex flex-col md:flex-row h-[calc(100vh+4rem)] bg-[var(--Black)]/90 shadow-2xl overflow-hidden">

  <!-- Colonne contacts -->
  <aside class="mt-16 w-full md:w-1/3 flex flex-col backdrop-blur-md border-r border-[var(--Rouge)] overflow-hidden">

    <!-- Header utilisateur amélioré -->
    <header
      class="mt-4 rounded-2xl p-4 md:p-5 mx-4 md:mx-10 flex items-center gap-4 bg-[var(--Black)]/50 border border-[var(--Rouge)] shadow-lg backdrop-blur-sm transition-transform hover:scale-[1.02]">

      <!-- Avatar utilisateur -->
      <div
        class="w-14 h-14 bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] text-white rounded-full flex items-center justify-center text-lg font-bold shadow-lg ring-2 ring-white/30 transition-transform hover:scale-110">
        {{ userInitiales }}
      </div>

      <!-- Infos utilisateur -->
      <div class="flex-1 min-w-0">
        <h2 class="font-semibold text-lg md:text-xl text-white truncate hover:text-[var(--Rouge)] transition-colors">
          {{ userPrenom }} {{ userNom }}
        </h2>
        
      </div>
    </header>

    <!-- Recherche contacts -->
    <div class="p-4 border-b border-white/20 relative">
      <label for="search-contact" class="sr-only">Rechercher un contact</label>
      <div class="relative">
        <input id="search-contact" type="text" placeholder="Rechercher un contact..." [(ngModel)]="searchText"
          (input)="onSearchChange(searchText)" (focus)="showSuggestions = filteredContacts.length > 0"
          (blur)="hideSuggestions()"
          class="w-full pl-12 pr-4 py-3 rounded-2xl bg-white/10 text-white placeholder-white/50 border border-white/20 focus:border-[var(--Rouge)] focus:ring-2 focus:ring-[var(--Rouge)]/40 focus:outline-none transition-all duration-300" />
        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-[var(--Rouge)]/80 text-lg"></i>
      </div>

      <!-- Suggestions -->
      <ul *ngIf="showSuggestions"
        class="absolute top-full left-0 right-0 bg-white/10 backdrop-blur-xl rounded-2xl shadow-xl max-h-56 overflow-y-auto z-20 mt-2 border border-white/20 animate-fade-in-up">
        <li *ngFor="let contact of getFilteredContacts()" (mousedown)="selectSuggestion(contact)"
          class="flex items-center gap-3 p-3 cursor-pointer hover:bg-white/20 transition-colors rounded-xl">
          <div
            class="w-10 h-10 rounded-full bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] text-white flex items-center justify-center text-sm font-semibold shadow">
            {{ contact.firstName[0] }}{{ contact.lastName[0] }}
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-medium text-white truncate">{{ contact.firstName }} {{ contact.lastName }}</div>
            <div class="text-xs text-white/60">Cliquez pour ouvrir</div>
          </div>
        </li>
      </ul>
    </div>

    <!-- Liste contacts -->
    <nav
      class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-[var(--Rouge)] scrollbar-track-transparent">
      <div *ngIf="contacts.length === 0" class="text-center text-white/60 text-sm py-10">
        Aucun contact disponible.
      </div>

      <a *ngFor="let contact of contacts; trackBy: trackByContactId; let idx = index" role="button" tabindex="0"
        (click)="selectContact(contact)" (keyup.enter)="selectContact(contact)"
        [attr.aria-label]="'Conversation avec ' + contact.firstName + ' ' + contact.lastName"
        [class.ring-2]="selectedContact?._id === contact._id"
        [class.ring-[var(--Rouge)]]="selectedContact?._id === contact._id"
        [class.shadow-lg]="selectedContact?._id === contact._id" class="contact-card group relative flex items-center justify-between gap-3 p-3 rounded-2xl
                bg-white/5 hover:bg-white/10 hover:scale-[1.02]
                focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2
                focus-visible:ring-offset-[var(--Fond)] focus-visible:ring-[var(--Rouge)]
                transition-all duration-300" style="animation:fadeIn .35s ease-out both"
        [style.animation-delay]="idx*30+'ms'">

        <div class="flex items-center gap-3 min-w-0">
          <div class="shrink-0 w-11 h-11 rounded-full
                      bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)]
                      text-white flex items-center justify-center
                      text-sm font-medium
                      ring-2 ring-white/20 shadow-sm">
            {{ contact.firstName[0] }}{{ contact.lastName[0] }}
          </div>
          <div class="min-w-0">
            <p class="text-sm text-white truncate">
              {{ contact.firstName }} {{ contact.lastName }}
            </p>
          </div>
        </div>

        <button (click)="deleteContact(contact); $event.stopPropagation()"
          [attr.aria-label]="'Supprimer ' + contact.firstName + ' ' + contact.lastName" class="shrink-0 w-9 h-9 rounded-full
                      text-white/70 bg-white/5
                      group-hover:bg-[var(--Rouge)]/20 group-hover:text-white
                      group-hover:opacity-100 opacity-0
                      transition-all duration-200
                      focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]">
          <i class="fa-solid fa-trash text-xs"></i>
        </button>
      </a>
    </nav>
  </aside>

  <!-- Zone chat -->
  <main class="mt-16 flex-1 flex flex-col bg-white/5 backdrop-blur-xl overflow-hidden">

    <ng-container *ngIf="selectedContact; else placeholder">

      <!-- Header chat -->
      <header
        class="mt-4 rounded-2xl p-4 md:p-5 mx-4 md:mx-10 flex items-center gap-4 bg-[var(--Black)]/50 border border-[var(--Rouge)] shadow-lg backdrop-blur-sm transition-transform sticky top-0 z-10 hover:scale-[1.02]">
        <div class="relative">
          <div
            class="w-14 h-14 bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] text-white rounded-full flex items-center justify-center text-lg font-bold shadow-lg ring-2 ring-white/30 transition-transform hover:scale-110">
            {{ selectedContact.firstName[0] }}{{ selectedContact.lastName[0] }}
          </div>
        </div>

        <div class="flex-1 min-w-0">
          <h2 class="font-semibold text-lg md:text-xl text-white truncate hover:text-[var(--Rouge)] transition-colors">
            {{ selectedContact.firstName }} {{ selectedContact.lastName }}
          </h2>
        </div>
      </header>

      <!-- Messages -->
      <section #messagesContainer role="log" aria-live="polite"
        class="flex-1 overflow-y-auto px-4 py-4 space-y-3 scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent">
        <article *ngFor="let msg of messages; trackBy: trackByMsgId"
          [attr.aria-label]="msg.senderName + ' : ' + msg.text" class="flex items-end gap-2 text-sm"
          [class.flex-row-reverse]="msg.senderId === userId">

          <div
            class="w-8 h-8 rounded-full bg-gradient-to-br from-[var(--Bleu)] to-[var(--Bleu-Foncé)] text-white text-xs font-semibold flex items-center justify-center ring-1 ring-white/20 shrink-0">
            {{ msg.senderId === userId ? userInitiales : getInitiales(msg.senderName) }}
          </div>

          <div class="max-w-[70%] min-w-[120px] group">
            <div class="text-white/40 text-[11px] px-1 mb-1 opacity-0 group-hover:opacity-100 transition"
              [ngClass]="{'text-right': msg.senderId === userId, 'text-left': msg.senderId !== userId}">
              {{ msg.timestamp | date:'HH:mm' }}
            </div>

            <div [ngClass]="msg.senderId === userId
                  ? 'bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] text-white rounded-br-md'
                  : 'bg-white/10 text-white rounded-bl-md backdrop-blur-sm'"
              class="relative px-4 py-2 rounded-2xl shadow-md break-words">
              <p>{{ msg.text }}</p>
              <div *ngIf="msg.senderId === userId && msg.id === messages[messages.length-1]?.id"
                class="absolute -bottom-1 -right-3 text-[10px] text-white/60">
                <i class="fa-solid fa-check-double"></i>
              </div>
            </div>
          </div>
        </article>
      </section>

      <!-- Input message -->
<footer class="absolute bottom-16 left-0 w-full p-4 bg-[var(--Black)]/25 backdrop-blur-md shadow-inner rounded-t-2xl border-t border-white/10 z-20">
  <form (ngSubmit)="sendMessage()" class="flex items-center gap-3">

    <!-- Input texte -->
    <input 
      id="message-input" 
      type="text" 
      [(ngModel)]="newMessage" 
      name="newMessage" 
      required
      placeholder="Écrire un message..."
      class="flex-1 px-5 py-3 rounded-full bg-white/10 text-white placeholder-white/50 border border-white/20
             focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]/60 focus:border-[var(--Rouge)]
             transition duration-300 ease-in-out shadow-md
             hover:bg-white/20"
    />

    <!-- Bouton envoyer -->
    <button 
      type="submit" 
      [disabled]="!newMessage?.trim() || isSending"
      [ngClass]="{
        'bg-[var(--Rouge)] hover:bg-[var(--Rouge-Foncé)]': newMessage?.trim() && !isSending,
        'bg-white/10 cursor-not-allowed': !newMessage?.trim() || isSending
      }" 
      class="p-3 rounded-full text-white transition-all shadow-md hover:shadow-lg flex items-center justify-center
             disabled:opacity-50 disabled:cursor-not-allowed"
      [attr.aria-label]="'Envoyer le message'">

      <ng-container *ngIf="!isSending; else loading">
        <i class="fas fa-paper-plane animate-bounce"></i>
      </ng-container>

      <ng-template #loading>
        <i class="fas fa-spinner fa-spin"></i>
      </ng-template>

    </button>

  </form>
</footer>



    </ng-container>

    <!-- Placeholder conversation -->
    <ng-template #placeholder>
      <div
        class="flex-1 flex flex-col items-center justify-center bg-gradient-to-b from-gray-900 to-black p-8 text-center"
        role="region" aria-label="Aucune conversation sélectionnée">
        <div
          class="border border-[var(--Rouge)]/70 rounded-3xl pt-12 pb-10 px-12 shadow-2xl ring-1 ring-white/10 bg-white/5 backdrop-blur-xl transition-all duration-300">
          <i class="fas fa-comments text-6xl text-[var(--Rouge)] mb-6 transition-transform duration-500"></i>
          <h3 class="text-2xl font-semibold text-white mb-3">Aucune conversation sélectionnée</h3>
          <p class="text-white/70 max-w-sm mb-6">
            Cliquez sur un contact pour lancer une discussion sécurisée.
          </p>
          <div class="flex items-center justify-center gap-2 text-white/50 text-xs mt-6">
            <i class="fas fa-lock-alt"></i>
            <span>Les messages sont supprimés automatiquement après 24 h.</span>
          </div>
        </div>
      </div>
    </ng-template>

  </main>
</div>